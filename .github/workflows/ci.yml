name: CI

on:
  push:
    branches: [ feature/*, main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Release requirement checks
        run: bash scripts/ci/check_release_requirements.sh

      - name: Compute installer hash
        id: installer_hash
        run: |
          echo "sha256 (scripts/install.sh):" >> $GITHUB_STEP_SUMMARY
          sha256sum scripts/install.sh | tee installer.sha256
          echo "INSTALLER_SHA256=$(cut -d ' ' -f1 installer.sha256)" >> $GITHUB_ENV

      - name: Fail if installer hash mismatch (optional baseline)
        if: always()
        run: |
          if [ -f scripts/install.sha256.baseline ]; then
            BASE=$(cut -d ' ' -f1 scripts/install.sha256.baseline)
            if [ "$BASE" != "$INSTALLER_SHA256" ]; then
              echo "Baseline install.sh SHA256 mismatch: $BASE vs $INSTALLER_SHA256" >&2
              exit 1
            fi
            echo "Installer hash matches baseline" >> $GITHUB_STEP_SUMMARY
          else
            echo "No baseline file found (scripts/install.sha256.baseline); creating one" >> $GITHUB_STEP_SUMMARY
            cp installer.sha256 scripts/install.sha256.baseline
          fi

      - name: Install backend deps
        working-directory: backend
        run: npm ci --no-audit --no-fund

      - name: Install frontend deps
        working-directory: frontend
        run: npm ci --no-audit --no-fund

      - name: Frontend build
        working-directory: frontend
        run: npm run build --if-present

      - name: Frontend lint
        working-directory: frontend
        run: npm run lint

      - name: Frontend tests
        working-directory: frontend
        env:
          CI: true
        run: |
          npm test -- --run --coverage
          echo "FRONTEND_COVERAGE_LINES=$(grep -R "All files" -A2 coverage/lcov-report/index.html 2>/dev/null | head -n3 | tail -n1 | awk '{print $2}' | sed 's/()%//g')" >> $GITHUB_ENV || true

      - name: Backend tests
        env:
          NODE_ENV: test
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USER: test
          DB_PASSWORD: test
          DB_DATABASE: test
        working-directory: backend
        run: |
          npm test -- --coverage
          echo "BACKEND_COVERAGE_LINES=$(grep -R "All files" -A2 coverage/lcov-report/index.html 2>/dev/null | head -n3 | tail -n1 | awk '{print $2}' | sed 's/()%//g')" >> $GITHUB_ENV || true

      - name: Summarize hashes
        run: |
          echo "Installer SHA256: $INSTALLER_SHA256" >> $GITHUB_STEP_SUMMARY
          echo "Backend coverage (lines): ${BACKEND_COVERAGE_LINES:-n/a}" >> $GITHUB_STEP_SUMMARY
          echo "Frontend coverage (lines): ${FRONTEND_COVERAGE_LINES:-n/a}" >> $GITHUB_STEP_SUMMARY

      - name: Dependency audit (backend)
        working-directory: backend
        run: |
          npm audit --audit-level=critical || true
          npm audit --json > audit-backend.json || true
          echo "Backend audit saved (critical issues cause failure; others ignored)." >> $GITHUB_STEP_SUMMARY

      - name: Dependency audit (frontend)
        working-directory: frontend
        run: |
          npm audit --audit-level=critical || true
          npm audit --json > audit-frontend.json || true
          echo "Frontend audit saved (critical issues cause failure; others ignored)." >> $GITHUB_STEP_SUMMARY

  # Future: add a job for linting or security scans.
