name: Smoke Install (Ubuntu)

on:
  workflow_dispatch:

jobs:
  smoke-install:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y postgresql postgresql-contrib certbot rsync curl tar python3

      - name: Start PostgreSQL
        run: |
          sudo systemctl start postgresql
          sudo systemctl status postgresql --no-pager || true

      - name: Install directly from checkout (latest main)
        env:
          DOMAIN: example.com
          LE_EMAIL: admin@example.com
          BACKEND_PORT: "3001"
          ADMIN_USER: admin
          ADMIN_PASS: admin123456
          APP_DB_HOST: localhost
          APP_DB_PORT: "5432"
          APP_DB_DATABASE: cmp
          APP_DB_USER: cmp
          APP_DB_PASSWORD: S3cret!pass
        run: |
          # Install from checked-out code instead of downloading release
          sudo mkdir -p /srv/cmp
          sudo rsync -a . /srv/cmp/ --exclude=.git
          
          # Setup database
          sudo -u postgres psql -c "CREATE ROLE cmp LOGIN PASSWORD 'S3cret!pass';" || true
          sudo -u postgres psql -c "CREATE DATABASE cmp OWNER cmp;" || true
          
          # Configure PostgreSQL for password auth
          PG_HBA=$(sudo -u postgres psql -d postgres -At -c "SHOW hba_file" 2>/dev/null || echo "/etc/postgresql/16/main/pg_hba.conf")
          if [ -f "$PG_HBA" ]; then
            sudo cp "$PG_HBA" "${PG_HBA}.bak"
            echo "host all all 127.0.0.1/32 scram-sha-256" | sudo tee -a "$PG_HBA"
            echo "host all all ::1/128 scram-sha-256" | sudo tee -a "$PG_HBA"
            sudo systemctl reload postgresql
          fi
          
          # Install dependencies and build
          cd /srv/cmp/backend
          sudo npm install --no-audit --no-fund
          cd /srv/cmp/frontend
          sudo npm install --no-audit --no-fund
          sudo npm run build
          
          # Create .env
          cd /srv/cmp/backend
          sudo tee .env > /dev/null <<EOF
          PORT=3001
          DOMAIN_NAME=example.com
          LETSENCRYPT_EMAIL=admin@example.com
          START_TELEGRAM_BOT=false
          JWT_SECRET=$(openssl rand -hex 48)
          DB_HOST=localhost
          DB_PORT=5432
          DB_DATABASE=cmp
          DB_USER=cmp
          DB_PASSWORD=S3cret!pass
          SEED_ADMIN_USERNAME=admin
          SEED_ADMIN_PASSWORD=admin123456
          EOF
          
          # Run migrations
          export $(cat .env | xargs)
          node run_migrations.js
          node seedAdmin.js
          
          # Create systemd service
          sudo tee /etc/systemd/system/cmp-backend.service > /dev/null <<'EOFSVC'
          [Unit]
          Description=CMP Backend Service
          After=network.target postgresql.service
          
          [Service]
          Type=simple
          User=root
          WorkingDirectory=/srv/cmp/backend
          ExecStart=/usr/bin/env node index.js
          Restart=on-failure
          RestartSec=5s
          StandardOutput=journal
          StandardError=journal
          
          [Install]
          WantedBy=multi-user.target
          EOFSVC
          
          sudo systemctl daemon-reload
          sudo systemctl enable cmp-backend
          sudo systemctl start cmp-backend
          sleep 3

      - name: Verify health endpoint
        run: |
          curl -fsS http://127.0.0.1:3001/api/health | tee health.json
          test -s health.json

      - name: Test login with admin credentials
        run: |
          curl -v -X POST http://127.0.0.1:3001/api/auth/login \
            -H "Content-Type: application/json" \
            -d '{"username":"admin","password":"admin123456"}' \
            | tee login_response.json
          # Check if we got a token back (should contain "token" field)
          grep -q '"token"' login_response.json || (echo "Login failed - no token returned" && exit 1)

      - name: Verify password hash in database
        run: |
          sudo -u postgres psql -d cmp -c "SELECT id, username, role, length(password_hash) as hash_length, substring(password_hash, 1, 10) as hash_prefix FROM admins WHERE username = 'admin';"

      - name: Print service logs on failure
        if: failure()
        run: |
          sudo journalctl -u cmp-backend.service --no-pager -n 200 || true
          sudo tail -n 200 /var/log/postgresql/* || true
          echo "=== Database admin records ==="
          sudo -u postgres psql -d cmp -c "SELECT id, username, role FROM admins;" || true
