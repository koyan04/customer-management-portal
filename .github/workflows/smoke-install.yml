name: Smoke Install (Ubuntu)

on:
  workflow_dispatch:

jobs:
  smoke-install:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y postgresql postgresql-contrib certbot rsync curl tar python3

      - name: Start PostgreSQL
        run: |
          sudo systemctl start postgresql
          sudo systemctl status postgresql --no-pager || true

      - name: Run installer (v1.1.7, no TLS, no nginx)
        env:
          CMP_CHECKOUT_REF: v1.1.7
          DOMAIN: example.com
          CF_AUTH_MODE: token
          CF_API_TOKEN: dummy-token
          LE_EMAIL: admin@example.com
          BACKEND_PORT: "3001"
          ADMIN_USER: admin
          ADMIN_PASS: admin123456
          APP_DB_HOST: localhost
          APP_DB_PORT: "5432"
          APP_DB_DATABASE: cmp
          APP_DB_USER: cmp
          APP_DB_PASSWORD: S3cret!pass
          CMP_DB_ADMIN_MODE: sudo
          CMP_ENABLE_NGINX: "0"
          CMP_SKIP_CERT: "1"
          CMP_HEALTH_PROBE_RETRIES: "12"
          CMP_HEALTH_PROBE_INTERVAL: "2"
        run: |
          curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/v1.1.7/Public_Release/scripts/install.sh -o install.sh
          sudo --preserve-env=DOMAIN,CF_AUTH_MODE,CF_API_TOKEN,LE_EMAIL,BACKEND_PORT,ADMIN_USER,ADMIN_PASS,APP_DB_HOST,APP_DB_PORT,APP_DB_DATABASE,APP_DB_USER,APP_DB_PASSWORD,CMP_DB_ADMIN_MODE,CMP_ENABLE_NGINX,CMP_SKIP_CERT,CMP_HEALTH_PROBE_RETRIES,CMP_HEALTH_PROBE_INTERVAL,CMP_CHECKOUT_REF bash install.sh

      - name: Verify health endpoint
        run: |
          curl -fsS http://127.0.0.1:3001/api/health | tee health.json
          test -s health.json

      - name: Print service logs on failure
        if: failure()
        run: |
          sudo journalctl -u cmp-backend.service --no-pager -n 200 || true
          sudo tail -n 200 /var/log/postgresql/* || true
