name: Smoke Install (Ubuntu)

on:
  workflow_dispatch:

jobs:
  smoke-install:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y postgresql postgresql-contrib certbot rsync curl tar python3

      - name: Start PostgreSQL
        run: |
          sudo systemctl start postgresql
          sudo systemctl status postgresql --no-pager || true

      - name: Run installer (latest main, no TLS, no nginx)
        env:
          CMP_CHECKOUT_REF: main
          DOMAIN: example.com
          CF_AUTH_MODE: token
          CF_API_TOKEN: dummy-token
          LE_EMAIL: admin@example.com
          BACKEND_PORT: "3001"
          ADMIN_USER: admin
          ADMIN_PASS: admin123456
          APP_DB_HOST: localhost
          APP_DB_PORT: "5432"
          APP_DB_DATABASE: cmp
          APP_DB_USER: cmp
          APP_DB_PASSWORD: S3cret!pass
          CMP_DB_ADMIN_MODE: sudo
          CMP_ENABLE_NGINX: "0"
          CMP_SKIP_CERT: "1"
          CMP_HEALTH_PROBE_RETRIES: "12"
          CMP_HEALTH_PROBE_INTERVAL: "2"
        run: |
          curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/scripts/install.sh -o install.sh
          sudo --preserve-env=DOMAIN,CF_AUTH_MODE,CF_API_TOKEN,LE_EMAIL,BACKEND_PORT,ADMIN_USER,ADMIN_PASS,APP_DB_HOST,APP_DB_PORT,APP_DB_DATABASE,APP_DB_USER,APP_DB_PASSWORD,CMP_DB_ADMIN_MODE,CMP_ENABLE_NGINX,CMP_SKIP_CERT,CMP_HEALTH_PROBE_RETRIES,CMP_HEALTH_PROBE_INTERVAL,CMP_CHECKOUT_REF bash install.sh

      - name: Verify health endpoint
        run: |
          curl -fsS http://127.0.0.1:3001/api/health | tee health.json
          test -s health.json

      - name: Test login with admin credentials
        run: |
          curl -v -X POST http://127.0.0.1:3001/api/auth/login \
            -H "Content-Type: application/json" \
            -d '{"username":"admin","password":"admin123456"}' \
            | tee login_response.json
          # Check if we got a token back (should contain "token" field)
          grep -q '"token"' login_response.json || (echo "Login failed - no token returned" && exit 1)

      - name: Verify password hash in database
        run: |
          sudo -u postgres psql -d cmp -c "SELECT id, username, role, length(password_hash) as hash_length, substring(password_hash, 1, 10) as hash_prefix FROM admins WHERE username = 'admin';"

      - name: Print service logs on failure
        if: failure()
        run: |
          sudo journalctl -u cmp-backend.service --no-pager -n 200 || true
          sudo tail -n 200 /var/log/postgresql/* || true
          echo "=== Database admin records ==="
          sudo -u postgres psql -d cmp -c "SELECT id, username, role FROM admins;" || true
